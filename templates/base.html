<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>{% block title %}Behringer & Partner{% endblock %}</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>

<body>
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="flash-messages-container">
        {% for category, message in messages %}
        <div class="alert alert-{{ category }}">
            {{ message }}
            <span class="close-flash" onclick="this.parentElement.style.display='none';">&times;</span>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}
    <header class="site-header">
        <div class="container header-inner">
            <a href="{{ url_for('index') }}" class="logo">
                <img src='{{ url_for("static", filename="images/layout/logo.png") }}' alt="Behringer & Partner Logo"
                    loading="lazy">
            </a>

            <nav class="main-nav">
                {% if back_url and back_text %}

                <ul class="nav-list">
                    <li>
                        <a href="{{ back_url }}" class="btn btn-secondary btn-sm">❮ Zurück zu {{ back_text }}</a>
                    </li>
                    <li><a href="{{ url_for('index') }}#contact" class="btn btn-primary btn-sm">Kontakt</a></li>
                </ul>

                {% else %}

                <ul class="nav-list">
                    <li><a href="{{ url_for('index') }}#about">Über uns</a></li>
                    <li><a href="{{ url_for('news') }}">Neuigkeiten</a></li>
                    <li class="nav-item dropdown">
                        <a href="{{ url_for('index') }}#services" aria-haspopup="true" aria-expanded="false">
                            <span>Leistungen <span class="dropdown-arrow">▼</span></span></a>
                        <ul class="dropdown-menu">
                            <li><a href="{{ url_for('siedlungswasserwirtschaft') }}">Siedlungswasserwirtschaft</a></li>
                            <li><a href="{{ url_for('strassenbau_brueckenbau') }}">Straßenbau & Brückenbau</a></li>
                            <li><a href="{{ url_for('fernwaerme') }}">Fernwärme</a></li>
                            <li><a href="{{ url_for('hydraulische_nachweise') }}">Hydraulische Nachweise</a></li>
                            <li><a href="{{ url_for('baulanderschliessung') }}">Baulanderschließung</a></li>
                            <li><a href="{{ url_for('kommunales_gis') }}">Kommunales GIS</a></li>
                            <li><a href="{{ url_for('sanierungen') }}">Sanierungen</a></li>
                            <li><a href="{{ url_for('wasserbau') }}">Wasserbau</a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a href="{{ url_for('index') }}#company" aria-haspopup="true" aria-expanded="false">
                            <span>Unternehmen <span class="dropdown-arrow">▼</span></span></a>
                        <ul class="dropdown-menu">
                            <li><a href="{{ url_for('unternehmen_team') }}">Team</a></li>
                            <li><a href="{{ url_for('firmengeschichte') }}">Firmengeschichte</a></li>
                            <li><a href="{{ url_for('unternehmen_netzwerk') }}">Netzwerk</a></li>
                            <li><a href="{{ url_for('unternehmen_stellenangebote') }}">Stellenangebote</a></li>
                        </ul>
                    </li>
                    <li><a href="{{ url_for('index') }}#contact" class="btn btn-primary">Kontakt</a></li>
                </ul>

                {% endif %}
            </nav>
            <button class="nav-toggle" aria-label="Menü öffnen" aria-expanded="false">☰</button>
        </div>
    </header>

    {% block content %}{% endblock %}

    <footer class="site-footer">
        <div class="container footer-grid">
            <div>
                <h4>Navigation</h4>
                <ul>
                    <li><a href="{{ url_for('index') }}#about">Über uns</a></li>
                    <li><a href="{{ url_for('news') }}">Neuigkeiten</a></li>
                    <li><a href="{{ url_for('index') }}#services">Leistungen</a></li>
                    <li><a href="{{ url_for('index') }}#company">Unternehmen</a></li>
                    <li><a href="{{ url_for('index') }}#contact">Kontakt</a></li>
                </ul>
            </div>
            <div>
                <h4>Leistungen</h4>
                <ul>
                    <li><a href="{{ url_for('siedlungswasserwirtschaft') }}">Siedlungswasserwirtschaft</a></li>
                    <li><a href="{{ url_for('strassenbau_brueckenbau') }}">Straßenbau & Brückenbau</a></li>
                    <li><a href="{{ url_for('fernwaerme') }}">Fernwärme</a></li>
                    <li><a href="{{ url_for('hydraulische_nachweise') }}">Hydraulische Nachweise</a></li>
                    <li><a href="{{ url_for('baulanderschliessung') }}">Baulanderschließung</a></li>
                    <li><a href="{{ url_for('kommunales_gis') }}">Kommunales GIS</a></li>
                    <li><a href="{{ url_for('sanierungen') }}">Sanierungen</a></li>
                    <li><a href="{{ url_for('wasserbau') }}">Wasserbau</a></li>
                </ul>
            </div>
            <div>
                <h4>Kontakt</h4>
                <address>
                    Behringer & Partner mbB<br>
                    Luitpoldallee 32<br>
                    D-84453 Mühldorf a. Inn<br>
                    <a href="tel:+4986319867900">Tel: +49 8631 98679-00</a><br>
                    <a href="mailto:info@ib-behringer.de">E-Mail: info@ib-behringer.de</a>
                </address>
            </div>
            <div>
                <h4>Rechtliches</h4>
                <ul>
                    <li><a href="{{ url_for('impressum') }}">Impressum</a></li>
                    <li><a href="{{ url_for('impressum') }}#datenschutz">Datenschutz</a></li>
                </ul>
            </div>
            <div>
                <h4>Folgen Sie uns</h4>
                <div class="footer-socials">
                    <a href="https://www.instagram.com/ibb_mue/" target="_blank" rel="noopener"
                        aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                </div>
                <h4 style="margin-top: 1.5rem;">Wir unterstützen</h4>
                <p style="margin-bottom: var(--space-xs); line-height: 1.4;">
                    <a href="{{ url_for('maedchenschule_chato') }}">Mädchenschule Chato, Tansania</a>
                </p>
                <a href="{{ url_for('maedchenschule_chato') }}">
                    <img src="https://www.ib-behringer.de/wp/wp-content/uploads/2022/12/Suedansicht-2-150x150.jpg"
                        alt="Mädchenschule Chato, Tansania" style="width:80px; border-radius:var(--radius-sm);">
                </a>
            </div>
        </div>
        <div class="footer-bottom">
            <p>© <span id="current-year">2024</span> Ingenieurbüro Behringer & Partner mbB. Alle Rechte vorbehalten.</p>
            <p><a href="{{ url_for('impressum') }}">Impressum</a> | <a
                    href="{{ url_for('impressum') }}#datenschutz">Datenschutz</a></p>
        </div>
    </footer>

    <div id="lightbox" class="lightbox">
        <span class="close-lightbox">×</span>
        <img class="lightbox-content" id="lightbox-image">
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const navToggle = document.querySelector('.nav-toggle');
            const navList = document.querySelector('.main-nav .nav-list');
            const siteHeader = document.querySelector('.site-header');

            // 1. Main Navigation Toggle (Hamburger)
            if (navToggle && navList) {
                navToggle.addEventListener('click', () => {
                    const isOpen = navList.classList.toggle('open');
                    navToggle.setAttribute('aria-expanded', isOpen);
                    navToggle.innerHTML = isOpen ? '×' : '☰';
                    if (!isOpen) {
                        navList.querySelectorAll('.dropdown-menu.submenu-open').forEach(submenu => submenu.classList.remove('submenu-open'));
                        navList.querySelectorAll('.nav-item.dropdown > a.active, .nav-item.dropdown > span.active').forEach(toggle => toggle.classList.remove('active'));
                    }
                });
            }

            // 2. Mobile Dropdown Submenu Toggle
            const dropdownToggles = navList ? navList.querySelectorAll('.nav-item.dropdown > a[aria-haspopup="true"]') : [];

            dropdownToggles.forEach(clickedToggle => {
                clickedToggle.addEventListener('click', function (event) {
                    event.preventDefault(); // Verhindert immer den Sprung zum Anker

                    const submenu = this.parentElement.querySelector('.dropdown-menu');
                    if (!submenu) return;

                    // Prüfen, ob das geklickte Menü bereits offen war
                    const wasOpen = submenu.classList.contains('submenu-open');

                    // Zuerst alle anderen Menüs schließen
                    dropdownToggles.forEach(toggle => {
                        if (toggle !== this) { // Schliesse nicht das gerade geklickte
                            toggle.classList.remove('active');
                            toggle.setAttribute('aria-expanded', 'false');
                            const otherSubmenu = toggle.parentElement.querySelector('.dropdown-menu');
                            if (otherSubmenu) {
                                otherSubmenu.classList.remove('submenu-open');
                            }
                        }
                    });

                    // Wenn das geklickte Menü nicht offen war, öffne es. Sonst schliesse es.
                    if (!wasOpen) {
                        this.classList.add('active');
                        submenu.classList.add('submenu-open');
                        this.setAttribute('aria-expanded', 'true');
                    } else {
                        this.classList.remove('active');
                        submenu.classList.remove('submenu-open');
                        this.setAttribute('aria-expanded', 'false');
                    }
                });
            });

            // NEU: Bei Klick ausserhalb des Menüs schliessen (für Desktop-Ansicht)
            document.addEventListener('click', function (event) {
                // Prüft, ob der Klick ausserhalb des Navigations-Containers (.main-nav) stattgefunden hat
                const mainNav = document.querySelector('.main-nav');
                if (mainNav && !mainNav.contains(event.target)) {
                    // Finde alle offenen Submenüs und schliesse sie
                    document.querySelectorAll('.dropdown-menu.submenu-open').forEach(submenu => {
                        submenu.classList.remove('submenu-open');
                    });
                    // Entferne auch den 'active' Status vom Toggle-Button
                    document.querySelectorAll('.nav-item.dropdown > a.active').forEach(toggle => {
                        toggle.classList.remove('active');
                        toggle.setAttribute('aria-expanded', 'false');
                    });
                }
            });

            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    const openSubmenu = navList.querySelector('.dropdown-menu.submenu-open');
                    if (openSubmenu) {
                        const associatedToggle = openSubmenu.parentElement.querySelector('a[aria-haspopup="true"]');

                        // Alle Menüs schließen
                        dropdownToggles.forEach(toggle => {
                            toggle.classList.remove('active');
                            toggle.setAttribute('aria-expanded', 'false');
                            const otherSubmenu = toggle.parentElement.querySelector('.dropdown-menu');
                            if (otherSubmenu) {
                                otherSubmenu.classList.remove('submenu-open');
                            }
                        });

                        // Fokus zurück auf den Button setzen, der das Menü geöffnet hat
                        if (associatedToggle) {
                            associatedToggle.focus();
                        }
                    }
                }
            });

            // 3. Smooth Scroll & Close Mobile Nav
            document.querySelectorAll('a[href]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    const href = this.getAttribute('href');
                    const isMobileView = navToggle && window.getComputedStyle(navToggle).display !== 'none';
                    let isMobileDropdownToggleItself = false;

                    if (isMobileView && this.parentElement && this.parentElement.classList.contains('dropdown') && this.closest('.nav-list') && this.querySelector('.dropdown-arrow')) {
                        const submenu = this.parentElement.querySelector('.dropdown-menu');
                        if (submenu) {
                            isMobileDropdownToggleItself = true;
                        }
                    }

                    if (href.startsWith('#') && href.length > 1) {
                        const targetElement = document.querySelector(href);
                        if (targetElement) {
                            e.preventDefault();
                            let headerOffset = siteHeader ? siteHeader.offsetHeight : 0;
                            const elementPosition = targetElement.getBoundingClientRect().top;
                            const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
                            window.scrollTo({ top: offsetPosition, behavior: 'smooth' });
                        }
                    } else if (href === '#') {
                        e.preventDefault();
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }

                    if (isMobileView && navList && navList.classList.contains('open') && !isMobileDropdownToggleItself) {
                        if (!href.startsWith('#') || (href.startsWith('#') && document.querySelector(href))) {
                            navList.classList.remove('open');
                            if (navToggle) {
                                navToggle.setAttribute('aria-expanded', 'false');
                                navToggle.innerHTML = '☰';
                            }
                            navList.querySelectorAll('.dropdown-menu.submenu-open').forEach(submenu => submenu.classList.remove('submenu-open'));
                            navList.querySelectorAll('.nav-item.dropdown > a.active, .nav-item.dropdown > span.active').forEach(toggle => toggle.classList.remove('active'));
                        }
                    }
                });
            });

            // Hero-Slideshow
            const slides = document.querySelectorAll('.hero-slideshow .hero-img');
            if (slides.length > 1) {
                let currentHeroSlide = 0;
                if (slides[currentHeroSlide]) slides[currentHeroSlide].classList.add('active');
                setInterval(() => {
                    if (slides[currentHeroSlide]) slides[currentHeroSlide].classList.remove('active');
                    currentHeroSlide = (currentHeroSlide + 1) % slides.length;
                    if (slides[currentHeroSlide]) slides[currentHeroSlide].classList.add('active');
                }, 5000);
            } else if (slides.length === 1 && slides[0]) {
                slides[0].classList.add('active');
            }

            // News Slider
            const newsSlider = document.querySelector('#news .news-slider');
            const newsItems = newsSlider ? newsSlider.querySelectorAll('.news-item') : [];
            const newsDotsContainer = document.querySelector('#news .news-dots');
            let currentNewsIndex = 0;
            let newsInterval;

            if (newsItems.length > 0 && newsDotsContainer) {
                newsItems.forEach((item, index) => {
                    const dot = document.createElement('span');
                    dot.classList.add('news-dot');
                    dot.dataset.index = index;
                    if (index === 0) dot.classList.add('active');
                    newsDotsContainer.appendChild(dot);
                });

                const newsDots = newsDotsContainer.querySelectorAll('.news-dot');

                function showNewsItem(index) {
                    newsItems.forEach(item => item.classList.remove('active'));
                    if (newsItems[index]) newsItems[index].classList.add('active');
                    newsDots.forEach(dot => dot.classList.remove('active'));
                    if (newsDots[index]) newsDots[index].classList.add('active');
                    currentNewsIndex = index;
                }

                function nextNewsItem() {
                    let nextIndex = (currentNewsIndex + 1) % newsItems.length;
                    showNewsItem(nextIndex);
                }

                newsDots.forEach(dot => {
                    dot.addEventListener('click', () => {
                        showNewsItem(parseInt(dot.dataset.index));
                        clearInterval(newsInterval);
                        newsInterval = setInterval(nextNewsItem, 7000);
                    });
                });

                showNewsItem(0);
                newsInterval = setInterval(nextNewsItem, 7000);
            }

            // Update current year in footer
            const yearSpan = document.getElementById('current-year');
            if (yearSpan) {
                yearSpan.textContent = new Date().getFullYear();
            }

            // IntersectionObserver für die "Über uns"-Sektion
            const aboutSection = document.getElementById('about');
            const aboutContentToReveal = aboutSection ? aboutSection.querySelector('.about-reveal-content') : null;
            if (aboutSection && aboutContentToReveal) {
                const revealAboutContent = (entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            aboutContentToReveal.classList.add('is-visible');
                            observer.unobserve(entry.target);
                        }
                    });
                };
                const aboutObserverOptions = { root: null, rootMargin: '0px', threshold: 0.1 };
                const aboutObserver = new IntersectionObserver(revealAboutContent, aboutObserverOptions);
                aboutObserver.observe(aboutSection);
            }

            // Click handler for service cards
            const serviceCards = document.querySelectorAll('.service-card');
            serviceCards.forEach(card => {
                const linkElement = card.querySelector('a.service-link-wrapper');
                if (linkElement) {
                    card.style.cursor = 'pointer';
                    card.addEventListener('click', () => {
                        window.location.href = linkElement.href;
                    });
                }
            });

            // Lightbox Funktionalität für das Teamfoto
            const teamPhotoContainer = document.getElementById('team-photo-container');
            const lightbox = document.getElementById('lightbox');
            const lightboxImage = document.getElementById('lightbox-image');
            const closeLightboxBtn = document.querySelector('.close-lightbox');

            if (teamPhotoContainer && lightbox && lightboxImage && closeLightboxBtn) {
                teamPhotoContainer.addEventListener('click', () => {
                    const originalImage = teamPhotoContainer.querySelector('img');
                    if (originalImage) {
                        lightboxImage.src = originalImage.src;
                        lightbox.classList.add('visible');
                    }
                });

                const closeLightbox = () => {
                    lightbox.classList.remove('visible');
                };

                closeLightboxBtn.addEventListener('click', closeLightbox);

                lightbox.addEventListener('click', (e) => {
                    if (e.target === lightbox) {
                        closeLightbox();
                    }
                });
                document.addEventListener('keydown', (e) => {
                    // Prüft, ob die gedrückte Taste "Escape" ist UND die Lightbox sichtbar ist
                    if (e.key === 'Escape' && lightbox.classList.contains('visible')) {
                        closeLightbox();
                    }
                });
            }
        });
    </script>

    {% block scripts %}{% endblock %}

</body>

</html>